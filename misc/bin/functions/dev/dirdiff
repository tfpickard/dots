#!/usr/bin/bash
# sdothum - 2016 (c) wtfpl

# Dev
# ══════════════════════════════════════════════════════════════════════════════

# ........................................................ Directory differences

usage() { echo "usage: $(basename $0) [-b] [-d <date>] [<source> [<target>]] [<regex>]", target must be full path; exit 1; }

ignore='backups|debian|\.history|makepkg|nixos|plugged-custom|qmk_firmware|root|snippets|undo|vps'

while [ "$1" ] ;do
  case $1 in
  -b) w=-w; diffopt='set diffopt+=iwhite' ;;                       # ignore whitespace
  -d) filter=/tmp/dirdiff:filter; touch -d "$2" $filter; shift ;;  # timestamp filter
  * ) break ;;
  esac
  shift
done

while [ "$1" ] ;do
  [ -d "$1" ] && { [ "$source" ] && target=$1 || source=$1; } || regex=$1
  shift
done

[ "$target" ] && { [ -d "$target" ] || { [ -d ./$target ] && target=$(pwd)/$target; } } || target=/net/archive$(pwd)
[ -d "$source" ] && cd "$source" || usage
[ -d "$target" ] || usage
[ "$regex"  ] || regex='.*'
source=$(pwd)

# to handle filenames containing spaces
find -L ./ -type f | exclude | egrep -v $ignore | grep "$regex" >/tmp/dirdiff:files
src=${source#$HOME/stow/*/}
src=\~/${src#$HOME/}

while read file <&3 ;do
  unset blink
  while : ;do
    [ $filter ] && [ "$file" -ot $filter ] && break
    clear
    [ $title ] || { ditto diff "[ $src/ ] $regex  <<-- -->>  $target"; title=true; }
    ditto diff "< $file"
    if ! diff --brief $w "$file" "$target/$file" >/dev/null 2>&1 ;then
      diff $w "$file" "$target/$file" | colordiff  # reverse diff --color highlighting
      # see herbstluftwm gvimdiff rule
      ifno "edit $file" && break || gvim -d -c "$diffopt" -f --role=gvimdiff "$file" "$target/$file"
      blink=${BLINK}
    else
      break
    fi
  done
done 3< /tmp/dirdiff:files

# vim: set ft=sh: #
